<div class="search-bar-wrapper">
  <div
    [class.has-auto-complete-items]="hasAutoCompleteGroups()"
    [class.show-auto-complete-items]="showAutoCompleteGroups"
    class="search-bar-input-container form-control flex-wrap"
  >
    <div *ngIf="loadingAutoCompleteItems" @fadeInOut class="loading-overlay"></div>

    <form
      (click)="searchInputEl.nativeElement.focus()"
      (ngSubmit)="onFormSubmit()"
      class="search-form d-flex align-items-center w-100"
      action="#"
    >
      <astrobin-loading-indicator *ngIf="!isBrowser" class="search-bar-input-loading-indicator">
      </astrobin-loading-indicator>
      <input
        #searchInput="ngModel"
        *ngIf="isBrowser"
        [extraWidth]="16"
        [includePlaceholder]="true"
        [ngModelOptions]="{ standalone: true }"
        [placeholder]="placeholder"
        [usePlaceHolderWhenEmpty]="true"
        (keydown.escape)="closeAutoCompleteSuggestions($event)"
        (keydown.tab)="!isTouchDevice && openAutoCompleteSuggestions($event)"
        (ngModelChange)="onModelChangeDebounced($event)"
        class="search-bar-input form-control"
        [(ngModel)]="model.text.value"
        autoSizeInput
        disableAutoFocusOnTouchDevices
        type="search"
      />

      <div
        *ngIf="
          !showAutoCompleteGroups &&
          (model.searchType === SearchType.IMAGE || model.searchType === undefined) &&
          model.text?.value?.length > 2 &&
          searchInputNgModel?.dirty
        "
        class="tab-or-enter-hint"
      >
        <ng-container *ngIf="isTouchDevice">
          <button
            *ngIf="hasAutoCompleteGroups()"
            (click)="openAutoCompleteSuggestions($event)"
            class="btn btn-link btn-xs"
            astrobinEventPreventDefault
            astrobinEventStopPropagation
            type="button"
          >
            <span class="d-none d-md-inline" translate="Show suggestions"></span>
            <fa-icon class="d-inline d-md-none" icon="circle-chevron-down"></fa-icon>
          </button>

          <button
            (click)="onSearch(model, !searchSettingsModel.simpleMode)"
            class="btn btn-link btn-xs"
            astrobinEventPreventDefault
            astrobinEventStopPropagation
            type="submit"
          >
            <span class="d-none d-md-inline" translate="Search"></span>
            <fa-icon class="d-inline d-md-none" icon="search"></fa-icon>
          </button>
        </ng-container>

        <ng-container *ngIf="!isTouchDevice">
          <span
            *ngIf="hasAutoCompleteGroups()"
            [innerHTML]="'Press <kbd>Tab</kbd> for suggestion, <kbd>Enter</kbd> to just search.' | translate"
          ></span>

          <span
            *ngIf="!searchSettingsModel.simpleMode && !hasAutoCompleteGroups()"
            [innerHTML]="'No suggestions available, press <kbd>Enter</kbd> for a free text search.' | translate"
          ></span>

          <span
            *ngIf="searchSettingsModel.simpleMode"
            [innerHTML]="'Press <kbd>Enter</kbd> to search.' | translate"
          ></span>
        </ng-container>

        <fa-icon
          *ngIf="!searchSettingsModel.simpleMode"
          (click)="showTabOrEnterInformation()"
          class="ms-2"
          icon="info-circle"
        ></fa-icon>
      </div>
    </form>
  </div>

  <div *ngIf="showAutoCompleteGroups && hasAutoCompleteGroups()" class="search-bar-autocomplete-items">
    <div *ngFor="let group of autoCompleteGroups | keys" class="search-bar-autocomplete-group flex-wrap">
      <h4 class="search-bar-autocomplete-title">
        {{ searchFilterService.humanizeSearchAutoCompleteType(group.key) }}
      </h4>

      <ng-container *ngIf="group.value === null">
        <fa-icon class="search-bar-autocomplete-item" animation="spin" icon="circle-notch"></fa-icon>
      </ng-container>

      <ng-container *ngIf="group.value !== null">
        <div
          #autoCompleteItem
          *ngFor="let item of group.value; let i = index"
          [class.selected]="item.type === selectedAutoCompleteGroup && i === selectedAutoCompleteItemIndex"
          (click)="onAutoCompleteItemClicked(item).subscribe()"
          (mouseenter)="selectedAutoCompleteItemIndex = i"
          class="search-bar-autocomplete-item"
        >
          <span [innerHTML]="item.label | highlight: model.text?.value"></span>
          <ng-container *ngIf="(searchFilterService.allowFilter$(item.minimumSubscription) | async) === false">
            <fa-icon class="ms-2" icon="lock"></fa-icon>
          </ng-container>
        </div>
      </ng-container>
    </div>
  </div>

  <div class="search-bar-icons">
    <ng-container *ngIf="loadingAutoCompleteItems; else resetAutoCompleteTemplate">
      <astrobin-loading-indicator class="search-bar-icons-loading-indicator"></astrobin-loading-indicator>
    </ng-container>

    <ng-template #resetAutoCompleteTemplate>
      <ng-container *ngIf="showAutoCompleteGroups && hasAutoCompleteGroups(); else iconsTemplate">
        <fa-icon (click)="resetAutoCompleteItems()" icon="times"></fa-icon>
      </ng-container>
    </ng-template>

    <ng-template #iconsTemplate>
      <fa-icon
        *ngIf="
          !searchSettingsModel.simpleMode && (model.searchType === SearchType.IMAGE || model.searchType === undefined)
        "
        [ngbTooltip]="isTouchDevice ? '' : ('Filters' | translate)"
        (click)="onFilterSelectionClicked($event)"
        container="body"
        icon="sliders"
      >
      </fa-icon>

      <div
        *ngIf="model.searchType === SearchType.IMAGE || model.searchType === undefined"
        class="mb-0"
        container="body"
        ngbDropdown
        placement="start-top"
      >
        <button id="ordering-button" class="btn btn-link no-toggle mb-0" ngbDropdownToggle type="button">
          <fa-icon
            [ngbTooltip]="isTouchDevice ? '' : ('Sort results' | translate)"
            container="body"
            icon="sort"
          ></fa-icon>
        </button>

        <div [attr.aria-labelledby]="'ordering-button'" class="ordering-menu" ngbDropdownMenu>
          <div class="dropdown-header">
            {{ "Sort by" | translate }}
          </div>

          <button (click)="onOrderingChanged('relevance')" ngbDropdownItem>
            <fa-icon icon="dot-circle"></fa-icon>
            <span>{{ "Relevance" | translate }}</span>
            <fa-icon *ngIf="model.ordering === 'relevance'" icon="check"></fa-icon>
          </button>

          <button (click)="onOrderingChanged('-published')" ngbDropdownItem>
            <fa-icon icon="calendar"></fa-icon>
            <span>{{ "Publication date" | translate }}</span>
            <fa-icon *ngIf="model.ordering === '-published'" icon="check"></fa-icon>
          </button>

          <button (click)="onOrderingChanged('-likes')" ngbDropdownItem>
            <fa-icon icon="thumbs-up"></fa-icon>
            <span>{{ "Number of likes" | translate }}</span>
            <fa-icon *ngIf="model.ordering === '-likes'" icon="check"></fa-icon>
          </button>

          <button (click)="onOrderingChanged('-bookmarks')" ngbDropdownItem>
            <fa-icon icon="bookmark"></fa-icon>
            <span>{{ "Number of bookmarks" | translate }}</span>
            <fa-icon *ngIf="model.ordering === '-bookmarks'" icon="check"></fa-icon>
          </button>

          <button (click)="onOrderingChanged('-views')" ngbDropdownItem>
            <fa-icon icon="eye"></fa-icon>
            <span>{{ "Number of views" | translate }}</span>
            <fa-icon *ngIf="model.ordering === '-views'" icon="check"></fa-icon>
          </button>

          <hr />

          <button (click)="onOrderingChanged('-integration')" ngbDropdownItem>
            <fa-icon icon="clock"></fa-icon>
            <span>{{ "Integration time" | translate }}</span>
            <fa-icon *ngIf="model.ordering === '-integration'" icon="check"></fa-icon>
          </button>

          <hr />

          <button (click)="onOrderingChanged('-field_radius')" ngbDropdownItem>
            <fa-icon icon="arrows-left-right-to-line"></fa-icon>
            <span>{{ "Field radius (large first)" | translate }}</span>
            <fa-icon *ngIf="model.ordering === '-field_radius'" icon="check"></fa-icon>
          </button>

          <button (click)="onOrderingChanged('field_radius')" ngbDropdownItem>
            <fa-icon icon="arrows-left-right-to-line"></fa-icon>
            <span>{{ "Field radius (small first)" | translate }}</span>
            <fa-icon *ngIf="model.ordering === 'field_radius'" icon="check"></fa-icon>
          </button>

          <hr />

          <button (click)="onOrderingChanged('-pixel_scale')" ngbDropdownItem>
            <fa-icon icon="square"></fa-icon>
            <span>{{ "Pixel scale (large first)" | translate }}</span>
            <fa-icon *ngIf="model.ordering === '-pixel_scale'" icon="check"></fa-icon>
          </button>

          <button (click)="onOrderingChanged('pixel_scale')" ngbDropdownItem>
            <fa-icon icon="square"></fa-icon>
            <span>{{ "Pixel scale (small first)" | translate }}</span>
            <fa-icon *ngIf="model.ordering === 'pixel_scale'" icon="check"></fa-icon>
          </button>

          <hr />

          <button (click)="onOrderingChanged('-coord_ra_min')" ngbDropdownItem>
            <fa-icon icon="crosshairs"></fa-icon>
            <span>{{ "Right ascension (descending)" | translate }}</span>
            <fa-icon *ngIf="model.ordering === '-coord_ra_min'" icon="check"></fa-icon>
          </button>

          <button (click)="onOrderingChanged('coord_ra_min')" ngbDropdownItem>
            <fa-icon icon="crosshairs"></fa-icon>
            <span>{{ "Right ascension (ascending)" | translate }}</span>
            <fa-icon *ngIf="model.ordering === 'coord_ra_min'" icon="check"></fa-icon>
          </button>

          <hr />

          <button (click)="onOrderingChanged('-coord_dec_min')" ngbDropdownItem>
            <fa-icon icon="crosshairs"></fa-icon>
            <span>{{ "Declination (descending)" | translate }}</span>
            <fa-icon *ngIf="model.ordering === '-coord_dec_min'" icon="check"></fa-icon>
          </button>

          <button (click)="onOrderingChanged('coord_dec_min')" ngbDropdownItem>
            <fa-icon icon="crosshairs"></fa-icon>
            <span>{{ "Declination (ascending)" | translate }}</span>
            <fa-icon *ngIf="model.ordering === 'coord_dec_min'" icon="check"></fa-icon>
          </button>
        </div>
      </div>

      <div class="mb-0" container="body" ngbDropdown placement="start-top">
        <button id="search-type-button" class="btn btn-link no-toggle mb-0" ngbDropdownToggle type="button">
          <fa-icon
            [icon]="getSearchTypeIcon(model.searchType)"
            [ngbTooltip]="isTouchDevice ? '' : ('Search area' | translate)"
            container="body"
          ></fa-icon>
        </button>

        <div [attr.aria-labelledby]="'search-type-button'" class="search-type-menu" ngbDropdownMenu>
          <div class="dropdown-header">
            {{ "Search area" | translate }}
          </div>

          <button (click)="onSearchTypeChanged(SearchType.IMAGE)" ngbDropdownItem>
            <fa-icon [icon]="getSearchTypeIcon(SearchType.IMAGE)"></fa-icon>
            <span>{{ "Images" | translate }}</span>
            <fa-icon
              *ngIf="model.searchType === SearchType.IMAGE || model.searchType === undefined"
              icon="check"
            ></fa-icon>
          </button>

          <button (click)="onSearchTypeChanged(SearchType.FORUM)" ngbDropdownItem>
            <fa-icon [icon]="getSearchTypeIcon(SearchType.FORUM)"></fa-icon>
            <span>{{ "Forums" | translate }}</span>
            <fa-icon *ngIf="model.searchType === SearchType.FORUM" icon="check"></fa-icon>
          </button>

          <button (click)="onSearchTypeChanged(SearchType.COMMENTS)" ngbDropdownItem>
            <fa-icon [icon]="getSearchTypeIcon(SearchType.COMMENTS)"></fa-icon>
            <span>{{ "Comments" | translate }}</span>
            <fa-icon *ngIf="model.searchType === SearchType.COMMENTS" icon="check"></fa-icon>
          </button>

          <button (click)="onSearchTypeChanged(SearchType.USERS)" ngbDropdownItem>
            <fa-icon [icon]="getSearchTypeIcon(SearchType.USERS)"></fa-icon>
            <span>{{ "Users" | translate }}</span>
            <fa-icon *ngIf="model.searchType === SearchType.USERS" icon="check"></fa-icon>
          </button>
        </div>
      </div>

      <ng-container *ngIf="currentUserWrapper$ | async as currentUserWrapper">
        <fa-icon
          *ngIf="currentUserWrapper.user && (model.searchType === SearchType.IMAGE || model.searchType === undefined)"
          [ngbTooltip]="isTouchDevice ? '' : ('Load or save search' | translate)"
          (click)="onLoadSaveClicked($event)"
          container="body"
          icon="database"
        ></fa-icon>
      </ng-container>

      <fa-icon
        *ngIf="model.searchType === SearchType.IMAGE || model.searchType === undefined"
        [ngbTooltip]="isTouchDevice ? '' : ('Settings' | translate)"
        (click)="onSearchSettingsClicked($event)"
        container="body"
        icon="cog"
      >
      </fa-icon>
    </ng-template>
  </div>
</div>

<div *ngIf="firstSearchDone && model.text?.value" class="alert alert-dark alert-mini search-bar-free-text-alert">
  <fa-icon icon="info-circle"></fa-icon>
  {{
    "AstroBin's search is powerful and flexible. We recommend that you use specific filters, instead of doing a free text search, if possible."
      | translate
  }}
  <a
    (click)="showTabOrEnterInformation()"
    class="alert-link"
    astrobinEventPreventDefault
    astrobinEventStopPropagation
    href="#"
  >
    {{ "Learn why." }}
  </a>
</div>

<div class="filters flex-wrap">
  <p
    *ngIf="!model.text?.value && filterComponentRefs?.length === 0"
    class="no-filters"
    translate="No filters applied yet. Search for something!"
  ></p>

  <astrobin-search-text-filter
    *ngIf="!!model.text?.value"
    [value]="model.text"
    (valueChanges)="onFilterValueChanges(SearchTextFilterComponent.key, $event)"
    class="search-filter-component"
  ></astrobin-search-text-filter>

  <ng-container #filterContainer></ng-container>

  <button
    *ngIf="model.text?.value || filterComponentRefs?.length > 0"
    (click)="reset()"
    class="btn btn-outline-secondary btn-xs"
  >
    {{ "Clear filters" | translate }}
  </button>
</div>

<div class="d-none">
  <!-- Used as a ViewRefContainer to add filters temporarily while their value is being edited. -->
  <ng-container #temporaryFilterContainer></ng-container>
</div>

<ng-template #tabOrEnterInformationOffcanvasTemplate let-offcanvas>
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">{{ "Info about the AstroBin Search" | translate }}</h5>
    <button (click)="offcanvas.close()" class="btn-close text-reset" type="button"></button>
  </div>

  <div class="offcanvas-body">
    <ng-container *ngTemplateOutlet="filterSearchRecommendationTemplate"></ng-container>
  </div>
</ng-template>

<ng-template #filterSearchRecommendationTemplate>
  <p
    [innerHTML]="
      'AstroBin recommends using specific filters to find equipment items, celestial subjects, and users. You can add filters by selecting the <strong>Filters</strong> icon on the right end of the search bar.'
        | translate
    "
  ></p>

  <p
    [innerHTML]="
      'If you want to perform a free text search, you can press <kbd>Enter</kbd> after typing. Free text searches are usually more inclusive and may return more results, as they search in all available fields. AstroBin will still try to show relevant results by matching your free text search to a filter, if there is a perfect match.'
        | translate
    "
  ></p>

  <p
    [innerHTML]="
      'The distinction between a free text search and a search using a specific filter can be illustrated with the following example. If you search for <strong>Orion</strong>, AstroBin cannot know if you want to see images OF the Orion constellations, images IN the Orion constellation, images of the Orion nebula, images taken with an Orion telescope, or images with somebody whose username is Orion. By using filters, you can specify what you are looking for exactly.'
        | translate
    "
  ></p>
</ng-template>

<ng-template #searchSettingsOffcanvasTemplate let-offcanvas>
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">{{ "Search settings" | translate }}</h5>
    <button (click)="offcanvas.close()" class="btn-close text-reset" type="button"></button>
  </div>

  <div class="offcanvas-body d-flex flex-column justify-content-between">
    <div class="mb-4 mb-md-0">
      <form class="search-settings-form">
        <formly-form
          [fields]="searchSettingsFields"
          [form]="searchSettingsForm"
          [model]="searchSettingsModel"
        ></formly-form>
      </form>
    </div>

    <div class="d-flex justify-content-end">
      <button (click)="offcanvas.close()" class="btn btn-secondary" type="button">
        {{ "Close" | translate }}
      </button>
    </div>
  </div>
</ng-template>
