<div class="annotation-tool-container" [class.active]="active">
  <!-- Fixed toolbar - making it simpler and more bulletproof -->
  <div class="fixed-top-toolbar">
    <h4>Create Annotation</h4>
    <div class="toolbar-buttons">
      <button type="button" (click)="makeArrow()">Arrow</button>
      <button type="button" (click)="makeRect()">Rectangle</button>
      <button type="button" (click)="makeCircle()">Circle</button>
      <button type="button" (click)="clearAll()">Clear</button>
      <button type="button" (click)="exitAnnotationModeHandler()">Exit</button>
    </div>
  </div>

  <!-- Annotation container with HTML elements instead of SVG -->
  <div class="annotation-container">
    <!-- Annotations layer -->
    <div class="annotation-layer">
      <!-- Rectangle annotations -->
      <div *ngFor="let ann of annotations"
           [ngClass]="{'annotation': true, 'rectangle': ann.type === 'rectangle', 'circle': ann.type === 'circle', 'arrow': ann.type === 'arrow'}"
           [style.left.%]="getAnnotationLeft(ann)"
           [style.top.%]="getAnnotationTop(ann)"
           [style.width.%]="getAnnotationWidth(ann)"
           [style.height.%]="getAnnotationHeight(ann)"
           [style.backgroundColor]="ann.color + '40'"
           [style.borderColor]="ann.color"
           [class.active]="currentlyDragging === ann"
           (mousedown)="startDrag($event, ann, 'whole')">

        <!-- Control points (corners) -->
        <div *ngIf="ann.type === 'rectangle'" class="control-points">
          <div class="control-point top-left" (mousedown)="startDrag($event, ann, 'tl')"></div>
          <div class="control-point top-right" (mousedown)="startDrag($event, ann, 'tr')"></div>
          <div class="control-point bottom-left" (mousedown)="startDrag($event, ann, 'bl')"></div>
          <div class="control-point bottom-right" (mousedown)="startDrag($event, ann, 'br')"></div>
        </div>

        <!-- Control points for circle -->
        <div *ngIf="ann.type === 'circle'" class="control-points">
          <div class="control-point right" (mousedown)="startDrag($event, ann, 'resize')"></div>
        </div>

        <!-- Control points for arrow -->
        <div *ngIf="ann.type === 'arrow'" class="control-points">
          <div class="control-point start"
               [style.left.%]="getArrowStartX(ann)"
               [style.top.%]="getArrowStartY(ann)"
               (mousedown)="startDrag($event, ann, 'start')"></div>
          <div class="control-point end"
               [style.left.%]="getArrowEndX(ann)"
               [style.top.%]="getArrowEndY(ann)"
               (mousedown)="startDrag($event, ann, 'end')"></div>
        </div>

        <!-- Arrow line and head -->
        <div *ngIf="ann.type === 'arrow'" class="arrow-line"
             [style.backgroundColor]="ann.color"
             [style.width.%]="getArrowLength(ann)"
             [style.transform]="getArrowTransform(ann)">
        </div>
        <div *ngIf="ann.type === 'arrow'" class="arrow-head"
             [style.borderLeftColor]="ann.color"
             [style.left.%]="getArrowHeadX(ann)"
             [style.top.%]="getArrowHeadY(ann)"
             [style.transform]="getArrowHeadTransform(ann)">
        </div>

        <!-- Toolbar for each annotation -->
        <div class="control-toolbar">
          <button class="tool-button delete" (click)="deleteAnnotation(ann.id); $event.stopPropagation()">üóëÔ∏è</button>
          <button class="tool-button message"
                 [class.has-message]="ann.note"
                 (click)="showMessageForm(ann.id); $event.stopPropagation()">üí¨</button>
        </div>
      </div>
    </div>

    <!-- Drawing overlay (for creating new shapes) -->
    <div class="drawing-overlay" *ngIf="active && !currentlyDragging">
      <!-- Preview of shape being drawn -->
      <div *ngIf="isDrawing && activeAnnotation" class="drawing-preview"
           [ngClass]="{'rectangle': activeAnnotation.shape.type === 'RECTANGLE',
                       'circle': activeAnnotation.shape.type === 'CIRCLE',
                       'arrow': activeAnnotation.shape.type === 'ARROW'}"
           [style.left.%]="getDrawingLeft()"
           [style.top.%]="getDrawingTop()"
           [style.width.%]="getDrawingWidth()"
           [style.height.%]="getDrawingHeight()"
           [style.backgroundColor]="activeAnnotation.shape.color + '40'"
           [style.borderColor]="activeAnnotation.shape.color">
      </div>
    </div>
  </div>

  <!-- Mouse event overlay -->
  <div class="mouse-event-overlay" *ngIf="currentlyDragging"
       [style.cursor]="getCursorForDragMode()"
       (mousemove)="dragMove($event)"
       (mouseup)="endDrag($event)"
       (mouseleave)="endDrag($event)"></div>

  <!-- Message Form Modal - Using system styles -->
  <div class="message-form-overlay" *ngIf="isMessageFormVisible" (click)="closeMessageForm()">
    <div class="message-form-container" (click)="$event.stopPropagation()">
      <div class="message-form-header">
        <h4>Add/Edit Message</h4>
        <button class="close-button" (click)="closeMessageForm()">√ó</button>
      </div>
      <div class="message-form-content">
        <!-- Simple form when formly is not available -->
        <div class="simple-form">
          <div class="form-group">
            <label for="annotation-message">Message</label>
            <textarea
              id="annotation-message"
              class="form-control"
              rows="5"
              [(ngModel)]="messageModel.message"
              placeholder="Enter a message for this annotation..."></textarea>
          </div>
          <div class="form-buttons">
            <button type="button" class="btn btn-secondary" (click)="closeMessageForm()">Cancel</button>
            <button type="button" class="btn btn-primary" (click)="submitMessageForm()">Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Annotation messages display -->
  <div class="annotation-messages">
    <div *ngFor="let ann of annotations" class="annotation-message" [style.display]="ann.note ? 'block' : 'none'">
      <div class="message-bubble"
           [style.left.%]="(ann.note?.position?.x || 50)"
           [style.top.%]="(ann.note?.position?.y || 50)">
        <div class="message-header">
          <span class="message-type">{{ann.type}}</span>
          <button type="button" class="close-message" (click)="annotationService.toggleNoteExpanded(ann.id)">
            {{ann.note?.expanded ? '‚àí' : '+'}}
          </button>
        </div>
        <div class="message-content" *ngIf="ann.note?.expanded">
          <p>{{ann.note?.text}}</p>
        </div>
      </div>
    </div>
  </div>
</div>
