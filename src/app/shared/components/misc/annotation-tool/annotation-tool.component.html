<div class="annotation-tool-container" [class.active]="active">
  <!-- Fixed toolbar - making it simpler and more bulletproof -->
  <div class="fixed-top-toolbar">
    <div class="toolbar-buttons">
      <button type="button" class="icon-button" title="Add Rectangle" (click)="makeRect()">
        <fa-icon [icon]="['fas', 'square']"></fa-icon>
      </button>
      <button type="button" class="icon-button" title="Add Circle" (click)="makeCircle()">
        <fa-icon [icon]="['fas', 'circle']"></fa-icon>
      </button>
      <button type="button" class="icon-button" title="{{ 'Clear All' | translate }}" 
              [disabled]="annotations.length === 0" 
              (click)="confirmClearAll()">
        <fa-icon [icon]="['fas', 'trash']"></fa-icon>
      </button>
      <button type="button" class="icon-button" title="Exit Annotation Mode" (click)="exitAnnotationModeHandler()">
        <fa-icon [icon]="['fas', 'times']"></fa-icon>
      </button>
    </div>
  </div>

  <!-- Annotation container with HTML elements instead of SVG -->
  <div class="annotation-container">
    <!-- Annotations layer -->
    <div class="annotation-layer">
      <!-- Rectangle annotations -->
      <div *ngFor="let ann of annotations"
           [ngClass]="{'annotation': true, 'rectangle': ann.type === 'rectangle', 'circle': ann.type === 'circle'}"
           [style.left.%]="getAnnotationLeft(ann)"
           [style.top.%]="getAnnotationTop(ann)"
           [style.width.%]="getAnnotationWidth(ann)"
           [style.height.%]="getAnnotationHeight(ann)"
           [style.paddingBottom.%]="ann.type === 'circle' ? getCircleAspectRatio(ann) : null"
           [style.backgroundColor]="ann.color + '4D'"
           [style.borderColor]="ann.color"
           [class.active]="currentlyDragging === ann"
           (mousedown)="startDrag($event, ann, 'whole')">
           
           <!-- Title display -->
           <div *ngIf="ann.title" class="annotation-title">
             {{ ann.title }}
           </div>

        <!-- Control points (corners) -->
        <div *ngIf="ann.type === 'rectangle'" class="control-points">
          <div class="control-point top-left" (mousedown)="startDrag($event, ann, 'tl')"></div>
          <div class="control-point top-right" (mousedown)="startDrag($event, ann, 'tr')"></div>
          <div class="control-point bottom-left" (mousedown)="startDrag($event, ann, 'bl')"></div>
          <div class="control-point bottom-right" (mousedown)="startDrag($event, ann, 'br')"></div>
        </div>

        <!-- Control points for circle - only top handle -->
        <div *ngIf="ann.type === 'circle'" class="control-points">
          <div class="control-point top" (mousedown)="startDrag($event, ann, 'resize')"></div>
        </div>

        <!-- Arrow mode has been removed -->

        <!-- Toolbar for each annotation -->
        <div class="control-toolbar" (mousedown)="$event.stopPropagation()">
          <button class="tool-button message"
                  (click)="showMessageForm(ann.id, annotationFormModal); $event.stopPropagation()">
            <fa-icon [icon]="['fas', 'file-alt']"></fa-icon>
          </button>

          <button class="tool-button delete" (click)="confirmDeleteAnnotation(ann.id); $event.stopPropagation()">
            <fa-icon icon="trash"></fa-icon>
          </button>
        </div>
      </div>
    </div>

    <!-- Drawing overlay (for creating new shapes) -->
    <div class="drawing-overlay" *ngIf="active && !currentlyDragging">
      <!-- Preview of shape being drawn -->
      <div *ngIf="isDrawing && activeAnnotation" class="drawing-preview"
           [ngClass]="{'rectangle': activeAnnotation.shape.type === 'RECTANGLE',
                       'circle': activeAnnotation.shape.type === 'CIRCLE'}"
           [style.left.%]="getDrawingLeft()"
           [style.top.%]="getDrawingTop()"
           [style.width.%]="getDrawingWidth()"
           [style.height.%]="activeAnnotation.shape.type === 'CIRCLE' ? 0 : getDrawingHeight()"
           [style.paddingBottom.%]="activeAnnotation.shape.type === 'CIRCLE' ? getDrawingWidth() : null"
           [style.backgroundColor]="activeAnnotation.shape.color + '4D'"
           [style.borderColor]="activeAnnotation.shape.color">
      </div>
    </div>
  </div>

  <!-- Mouse event overlay -->
  <div class="mouse-event-overlay" *ngIf="currentlyDragging"
       [style.cursor]="getCursorForDragMode()"
       (mousemove)="dragMove($event)"
       (mouseup)="endDrag($event)"
       (mouseleave)="endDrag($event)"></div>


  <!-- NgbModal Template -->
  <ng-template #annotationFormModal let-modal>
    <div class="modal-header">
      <h4 class="modal-title">{{ (pendingShapeData ? 'Create Annotation' : 'Edit Annotation') | translate }}</h4>
      <button type="button" class="close" [attr.aria-label]="'Close' | translate" (click)="modal.dismiss()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-body">
      <!-- Use ngx-formly form -->
      <form [formGroup]="messageForm">
        <formly-form [form]="messageForm" [fields]="messageFields" [model]="messageModel"></formly-form>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="modal.dismiss()">{{ 'Cancel' | translate }}</button>
      <button type="button" class="btn btn-primary" [disabled]="!messageForm.valid" (click)="validateAndCloseModal(modal, messageForm, messageForm.value, $event)">{{ 'Confirm' | translate }}</button>
    </div>
  </ng-template>

  <!-- We've removed the message bubbles as requested -->
</div>
