<!-- Loading indicator for URL annotations -->
<div *ngIf="loadingUrlAnnotations" class="url-annotations-loading-indicator">
  <div class="spinner-border text-light" role="status">
    <span class="visually-hidden">{{ 'Loading annotations from URL...' | translate }}</span>
  </div>
  <div class="loading-text mt-2">{{ 'Loading annotations from URL...' | translate }}</div>
  
  <!-- Skip loading button (immediate option for all devices) -->
  <button class="btn btn-sm btn-primary mt-3" 
          (click)="loadingUrlAnnotations = false; cdRef.markForCheck();">
    {{ 'Show annotations now' | translate }}
  </button>
</div>

<div class="annotation-tool-container pointer-events-all" [class.active]="active" data-ignore-swipe-down="true">
  <!-- Fixed toolbar - making it simpler and more bulletproof -->
  <div class="fixed-top-toolbar">
    <div class="toolbar-buttons">
      <!-- Drawing tools -->
      <button type="button" class="icon-button" title="Add Rectangle" 
              (click)="makeRect()"
              (touchend)="makeRect()">
        <fa-icon [icon]="['fas', 'square']"></fa-icon>
      </button>
      <button type="button" class="icon-button" title="Add Circle" 
              (click)="makeCircle()"
              (touchend)="makeCircle()">
        <fa-icon [icon]="['fas', 'circle']"></fa-icon>
      </button>
      
      <!-- Actions -->
      <button *ngIf="isImageOwner && imageId"
              type="button"
              class="icon-button"
              title="{{ 'Save Annotations' | translate }}"
              [disabled]="annotations.length === 0"
              (click)="saveAnnotations()"
              (touchend)="annotations.length > 0 ? saveAnnotations() : null"
              (touchstart)="$event.stopPropagation()">
        <fa-icon [icon]="['fas', 'save']"></fa-icon>
      </button>
      <button type="button"
              class="icon-button"
              title="{{ 'Share Annotations' | translate }}"
              [disabled]="annotations.length === 0"
              (click)="annotations.length > 0 ? shareAnnotations() : null"
              (touchstart)="$event.stopPropagation()"
              (touchend)="annotations.length > 0 ? shareAnnotations() : null">
        <fa-icon [icon]="['fas', 'share-alt']"></fa-icon>
      </button>
      
      <!-- Exit/Clear section with a visual separator -->
      <div class="toolbar-separator"></div>
      
      <button type="button" 
              class="icon-button" 
              title="{{ 'Clear All' | translate }}"
              [disabled]="annotations.length === 0"
              (click)="confirmClearAll()"
              (touchend)="annotations.length > 0 ? confirmClearAll() : null"
              (touchstart)="$event.stopPropagation()">
        <fa-icon [icon]="['fas', 'eraser']"></fa-icon>
      </button>
      <button type="button" class="icon-button exit-button" 
              title="Exit Annotation Mode" 
              (click)="exitAnnotationModeHandler(); annotationService.clearAllAnnotations()"
              (touchend)="exitAnnotationModeHandler(); annotationService.clearAllAnnotations()"
              (touchstart)="$event.stopPropagation()">
        <fa-icon [icon]="['fas', 'times']"></fa-icon>
      </button>
    </div>
  </div>

  <!-- Annotation container with HTML elements instead of SVG -->
  <div class="annotation-container" data-ignore-swipe-down="true">
    <!-- Annotations layer -->
    <div class="annotation-layer" data-ignore-swipe-down="true">
      <!-- Rectangle annotations - only show when not loading -->
      <div *ngFor="let ann of annotations"
           [ngClass]="{'annotation': true, 'rectangle': ann.type === 'rectangle', 'circle': ann.type === 'circle'}"
           [style.left.%]="getAnnotationLeft(ann)"
           [style.top.%]="getAnnotationTop(ann)"
           [style.width.%]="getAnnotationWidth(ann)"
           [style.height.%]="getAnnotationHeight(ann)"
           [style.paddingBottom.%]="ann.type === 'circle' ? getCircleAspectRatio(ann) : null"
           [style.backgroundColor]="ann.color + '4D'"
           [style.borderColor]="ann.color"
           [class.active]="currentlyDragging === ann"
           [style.visibility]="loadingUrlAnnotations ? 'hidden' : 'visible'"
           data-ignore-swipe-down="true"
           (mousedown)="startDrag($event, ann, 'whole')"
           (touchstart)="startDragTouch($event, ann, 'whole')">

           <!-- Title display -->
           <div *ngIf="ann.title" class="annotation-title">
             {{ ann.title }}
           </div>

        <!-- Control points (corners) -->
        <div *ngIf="ann.type === 'rectangle'" class="control-points">
          <div class="control-point top-left" 
               data-ignore-swipe-down="true"
               (mousedown)="startDrag($event, ann, 'tl')"
               (touchstart)="startDragTouch($event, ann, 'tl')"></div>
          <div class="control-point top-right" 
               data-ignore-swipe-down="true"
               (mousedown)="startDrag($event, ann, 'tr')"
               (touchstart)="startDragTouch($event, ann, 'tr')"></div>
          <div class="control-point bottom-left" 
               data-ignore-swipe-down="true"
               (mousedown)="startDrag($event, ann, 'bl')"
               (touchstart)="startDragTouch($event, ann, 'bl')"></div>
          <div class="control-point bottom-right" 
               data-ignore-swipe-down="true"
               (mousedown)="startDrag($event, ann, 'br')"
               (touchstart)="startDragTouch($event, ann, 'br')"></div>
        </div>

        <!-- Control points for circle - only top handle -->
        <div *ngIf="ann.type === 'circle'" class="control-points">
          <div class="control-point top" 
               data-ignore-swipe-down="true"
               (mousedown)="startDrag($event, ann, 'resize')"
               (touchstart)="startDragTouch($event, ann, 'resize')"></div>
        </div>

        <!-- Arrow mode has been removed -->

        <!-- Toolbar for each annotation -->
        <div class="control-toolbar" 
             (mousedown)="$event.stopPropagation()" 
             (touchstart)="$event.stopPropagation()">
          <button class="tool-button message"
                  (click)="showMessageForm(ann.id, annotationFormModal); $event.stopPropagation()">
            <fa-icon [icon]="['fas', 'file-alt']"></fa-icon>
          </button>

          <button class="tool-button delete" (click)="confirmDeleteAnnotation(ann.id); $event.stopPropagation()">
            <fa-icon icon="trash"></fa-icon>
          </button>
        </div>
      </div>
    </div>

    <!-- Drawing overlay (for creating new shapes) - hidden during loading -->
    <div class="drawing-overlay" *ngIf="active && !currentlyDragging && !loadingUrlAnnotations">
      <!-- Preview of shape being drawn -->
      <div *ngIf="isDrawing && activeAnnotation" class="drawing-preview"
           [ngClass]="{'rectangle': activeAnnotation.shape.type === 'RECTANGLE',
                       'circle': activeAnnotation.shape.type === 'CIRCLE'}"
           [style.left.%]="getDrawingLeft()"
           [style.top.%]="getDrawingTop()"
           [style.width.%]="getDrawingWidth()"
           [style.height.%]="activeAnnotation.shape.type === 'CIRCLE' ? 0 : getDrawingHeight()"
           [style.paddingBottom.%]="activeAnnotation.shape.type === 'CIRCLE' ? getDrawingWidth() : null"
           [style.backgroundColor]="activeAnnotation.shape.color + '4D'"
           [style.borderColor]="activeAnnotation.shape.color">
      </div>
    </div>
  </div>

  <!-- Mouse event overlay - hidden during loading -->
  <div class="mouse-event-overlay" *ngIf="currentlyDragging && !loadingUrlAnnotations"
       [style.cursor]="getCursorForDragMode()"
       data-ignore-swipe-down="true"
       (mousemove)="dragMove($event)"
       (mouseup)="endDrag($event)"
       (mouseleave)="endDrag($event)"
       (touchmove)="dragMoveTouch($event)"
       (touchend)="endDragTouch($event)"
       (touchcancel)="endDragTouch($event)"></div>


  <!-- NgbModal Template -->
  <ng-template #annotationFormModal let-modal>
    <div class="modal-header">
      <h4 class="modal-title" *ngIf="pendingShapeData">{{ 'Create annotation' | translate }}</h4>
      <h4 class="modal-title" *ngIf="!pendingShapeData">{{ 'Edit annotation' | translate }}</h4>
      <button type="button" class="close" [attr.aria-label]="'Close' | translate" (click)="modal.dismiss()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-body">
      <!-- Use ngx-formly form -->
      <form [formGroup]="messageForm">
        <formly-form [form]="messageForm" [fields]="messageFields" [model]="messageModel"></formly-form>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="modal.dismiss()">{{ 'Cancel' | translate }}</button>
      <button type="button" class="btn btn-primary" [disabled]="!messageForm.valid" (click)="validateAndCloseModal(modal, messageForm, messageForm.value, $event)">{{ 'Confirm' | translate }}</button>
    </div>
  </ng-template>

  <!-- We've removed the message bubbles as requested -->
</div>
