<div [class.loading]="!imageObjectLoaded" class="image-loading-container">
  <ng-container [ngTemplateOutlet]="loadingTemplate"></ng-container>
</div>

<div
  *ngIf="!!image"
  [hidden]="!imageObjectLoaded"
  class="main-area-container overflow-hidden d-flex flex-column w-100 h-100"
>
  <astrobin-mobile-menu
    [iconsTemplate]="mobileMenuIconsTemplate"
    [offcanvasBackdropClass]="'image-viewer-offcanvas-backdrop'"
    [offcanvasClass]="'image-viewer-offcanvas'"
    [template]="navTemplate"
    [templateContext]="{ $implicit: image }"
    [titleTemplate]="mobileMenuTitleTemplate"
    (menuClose)="onMobileMenuClose()"
    (menuOpen)="onMobileMenuOpen()"
  ></astrobin-mobile-menu>

  <div #mainArea class="main-area">
    <ng-container [ngTemplateOutlet]="imageAreaTemplate"></ng-container>

    <div class="data-area-container">
      <ng-container [ngTemplateOutlet]="dataAreaTemplate"></ng-container>
      <div class="data-area-bottom-gradient"></div>
    </div>
    <!-- data-area-container -->
  </div>

  <astrobin-scroll-to-top #scrollToTopMdMax *ngIf="deviceService.mdMax()" [element]="mainArea"></astrobin-scroll-to-top>

  <astrobin-scroll-to-top
    #scrollToTopLgMin
    *ngIf="deviceService.lgMin()"
    [element]="dataArea?.nativeElement"
  ></astrobin-scroll-to-top>
</div>

<ng-template #loadingTemplate>
  <astrobin-loading-indicator></astrobin-loading-indicator>
</ng-template>

<ng-template #mobileMenuTitleTemplate>
  {{ "Image" | translate }}
</ng-template>

<ng-template #mobileMenuIconsTemplate>
  <astrobin-image-viewer-share-button
    [image]="image"
    [revisionLabel]="revisionLabel"
  ></astrobin-image-viewer-share-button>
  <button *ngIf="showCloseButton" (click)="closeClick.emit()" class="btn btn-link btn-no-block text-white">
    <fa-icon icon="times"></fa-icon>
  </button>
</ng-template>

<ng-template #navTemplate let-image>
  <astrobin-image-viewer-menu
    [image]="image"
    [revisionLabel]="revisionLabel"
    dividerClass="menu-divider"
    itemClass="menu-item"
  ></astrobin-image-viewer-menu>
</ng-template>

<ng-template #imageAreaTemplate>
  <div
    #imageArea
    [class.adjustment-editor-visible]="adjustmentEditorVisible"
    [class.force-view-annotations-mousehover]="forceViewAnnotationsMouseHover"
    [class.force-view-mousehover]="forceViewMouseHover"
    [class.has-top-banner]="image && image.isIotd"
    (mouseenter)="revision?.solution && !adjustmentEditorVisible && (showNorthArrow = true)"
    (mouseleave)="showNorthArrow = false"
    class="image-area"
  >
    <div class="image-area-header">
      <astrobin-image-viewer-iotd-banner
        *ngIf="image && image.isIotd"
        [image]="image"
      ></astrobin-image-viewer-iotd-banner>
    </div>

    <div class="image-area-body">
      <!-- Moon scale overlay -->
      <div
        *ngIf="showMoonOverlay && moonScaleDiameter > 0"
        @fadeInOut
        [class.dragging]="isDraggingMoon"
        [style.left]="moonPosition.x + '%'"
        [style.top]="moonPosition.y + '%'"
        (pointerdown)="onMoonDragStart($event)"
        class="moon-scale-overlay"
        data-ignore-swipe-down="true"
      >
        <!-- Placeholder circle shown while image is loading -->
        <div
          *ngIf="!isMoonImageLoaded"
          [style.height.px]="moonScaleDiameter"
          [style.width.px]="moonScaleDiameter"
          class="moon-placeholder"
        ></div>

        <!-- Actual moon image -->
        <img
          [class.hidden]="!isMoonImageLoaded"
          [height]="moonScaleDiameter"
          [src]="moonImageSrc"
          [width]="moonScaleDiameter"
          (error)="isMoonImageLoaded = false"
          (load)="onMoonImageLoaded()"
          class="moon-image"
          alt="Moon scale"
          draggable="false"
        />

        <div class="moon-label-container">
          <span class="moon-label">{{ "Moon scale" | translate }}</span>
          <div class="divider"></div>
          <div class="moon-controls">
            <span
              [ngbPopover]="moonInfoPopover"
              class="icon-btn info-icon"
              container="body"
              placement="bottom"
              popoverClass="moon-info-popover"
              title="{{ 'About moon scale' | translate }}"
              triggers="click hover"
            >
              <fa-icon icon="info-circle"></fa-icon>
            </span>
            <button
              (click)="$event.stopPropagation(); resetMoonOverlay()"
              class="icon-btn close-moon-btn"
              title="{{ 'Close' | translate }}"
            >
              <fa-icon icon="times"></fa-icon>
            </button>
          </div>
        </div>

        <ng-template #moonInfoPopover>
          <div class="moon-info-content">
            {{
              "This scale represents the apparent size of the full moon (0.52Â° diameter) based on the plate-solved pixel scale of the image. The actual apparent size of the moon varies slightly throughout the year due to its elliptical orbit."
                | translate
            }}
          </div>
        </ng-template>
      </div>

      <ng-container *ngIf="adjustmentEditorVisible && isBrowser">
        <astrobin-image-viewer-adjustment-editor
          [image]="image"
          [imageComponent]="imageComponent"
          [revisionLabel]="revisionLabel"
          (closeClick)="adjustmentEditorVisible = false"
          class="adjustment-editor"
        ></astrobin-image-viewer-adjustment-editor>
      </ng-container>

      <ng-container *ngIf="!adjustmentEditorVisible">
        <!-- North arrow -->
        <div
          *ngIf="showNorthArrow && revision?.solution?.orientation !== null"
          @fadeInOut
          [ngStyle]="{
            transform: 'translateX(-50%) rotate(' + northArrowRotation * -1 + 'deg)'
          }"
          class="north-arrow-container"
        >
          <div class="north-arrow-wrapper">
            <img class="north-arrow" alt="Compass" src="assets/images/compass.svg?v=1" />
            <div
              [ngbTooltip]="'Celestial North' | translate"
              [ngStyle]="{
                transform: 'rotate(' + northArrowRotation + 'deg)'
              }"
              class="north-arrow-label"
              container="body"
            >
              N
            </div>
          </div>
        </div>

        <astrobin-image-viewer-close-button
          *ngIf="showCloseButton"
          (closeClick)="closeClick.emit()"
          class="close-button d-none d-md-block"
        ></astrobin-image-viewer-close-button>

        <astrobin-image-viewer-additional-buttons
          *ngIf="image && imageFileLoaded"
          [allowTogglingAnnotationsOnMouseHover]="revision.mouseHoverImage === MouseHoverImageOptions.SOLUTION"
          [forceViewMouseHover]="forceViewMouseHover"
          [hasMouseHover]="
            revision.mouseHoverImage !== MouseHoverImageOptions.NOTHING &&
            (!!nonSolutionMouseHoverImage || !!solutionMouseHoverImage || !!inlineSvg)
          "
          [image]="image"
          [moonOverlayActive]="showMoonOverlay"
          [revisionLabel]="revisionLabel"
          [showAnnotationsOnMouseHover]="imageViewerService.showAnnotationsOnMouseHover"
          (onToggleAnnotationsOnMouseHoverEnter)="onToggleAnnotationsOnMouseHoverEnter()"
          (onToggleAnnotationsOnMouseHoverLeave)="onToggleAnnotationsOnMouseHoverLeave()"
          (showAdjustmentsEditor)="adjustmentEditorVisible = true"
          (toggleAnnotationsOnMouseHover)="imageViewerService.toggleShowAnnotationsOnMouseHover()"
          (toggleMoonOverlay)="toggleMoonOverlay()"
          (toggleViewMouseHover)="toggleViewMouseHover()"
          class="additional-buttons"
        >
        </astrobin-image-viewer-additional-buttons>
      </ng-container>

      <button *ngIf="showPreviousButton" (click)="onArrowLeft($event)" class="previous-button">
        <fa-icon icon="chevron-left"></fa-icon>
      </button>

      <astrobin-fullscreen-image-viewer
        *ngIf="standalone && supportsFullscreen"
        [eagerLoading]="true"
        [id]="image.pk"
        [revisionLabel]="revisionLabel"
        [standalone]="standalone"
        (exitFullscreen)="exitFullscreen()"
      ></astrobin-fullscreen-image-viewer>

      <astrobin-image
        #imageComponent
        @fadeInOut
        [alias]="alias"
        [autoHeight]="true"
        [class.supports-fullscreen]="supportsFullscreen"
        [forceLoad]="true"
        [image]="image"
        [revisionLabel]="revisionLabel"
        (imageClick)="enterFullscreen($event)"
        (imageMouseEnter)="onImageMouseEnter($event)"
        (imageMouseLeave)="onImageMouseLeave($event)"
        (imageTouchstart)="enterFullscreen($event)"
        (loaded)="onImageLoaded()"
      ></astrobin-image>

      <!--
        If the mouse-hover settings indicate a non-solution mouse-hover, we always show it on hover. Except if the
        solution mouse-hover is being forced.
      -->
      <div
        *ngIf="
          imageFileLoaded &&
          revision.mouseHoverImage !== MouseHoverImageOptions.SOLUTION &&
          nonSolutionMouseHoverImage &&
          !forceViewAnnotationsMouseHover
        "
        (intentionalClick)="enterFullscreen($event)"
        class="mouse-hover-container"
        astrobinPreventScrollClick
      >
        <img
          [style.max-width.px]="revision.w"
          (mouseenter)="onImageMouseEnter($event)"
          (mouseleave)="onImageMouseLeave($event)"
          class="mouse-hover ready"
          alt=""
          src="{{ nonSolutionMouseHoverImage }}"
        />
      </div>

      <!--
        If the mouse-hover settings indicate a solution mouse-hover, and there is one available, we show it according to
        mouse-hover settings (hover on image vs hover on button).
      -->
      <div
        *ngIf="
          imageFileLoaded &&
          (revision.mouseHoverImage === MouseHoverImageOptions.SOLUTION || forceViewAnnotationsMouseHover) &&
          solutionMouseHoverImage &&
          !inlineSvg
        "
        (intentionalClick)="enterFullscreen($event)"
        class="mouse-hover-container"
        astrobinPreventScrollClick
      >
        <img
          [style.max-width.px]="revision.w"
          (mouseenter)="onImageMouseEnter($event)"
          (mouseleave)="onImageMouseLeave($event)"
          class="mouse-hover ready"
          alt=""
          src="{{ solutionMouseHoverImage }}"
        />
      </div>

      <div
        *ngIf="
          imageFileLoaded &&
          (revision.mouseHoverImage === MouseHoverImageOptions.SOLUTION || forceViewAnnotationsMouseHover) &&
          inlineSvg
        "
        (intentionalClick)="enterFullscreen($event)"
        class="mouse-hover-svg-container"
        astrobinPreventScrollClick
      >
        <div
          [id]="'mouse-hover-svg-' + image.pk + '-' + revision.pk"
          [innerHTML]="inlineSvg"
          (mouseenter)="onImageMouseEnter($event)"
          (mouseleave)="onImageMouseLeave($event)"
          (mousemove)="onSvgMouseMove($event)"
          class="mouse-hover w-100 position-relative"
        ></div>

        <div class="mouse-hover-svg-overlay">
          <astrobin-loading-indicator
            *ngIf="!advancedSolutionMatrix && loadingAdvancedSolutionMatrix"
          ></astrobin-loading-indicator>

          <div *ngIf="!!advancedSolutionMatrix" class="mouse-hover-svg-overlay-coordinates">
            <div class="ra-dec d-flex gap-2" ngbTooltip="RA/Dec">
              <span [innerHTML]="mouseHoverRa"></span>
              <span [innerHTML]="mouseHoverDec"></span>
            </div>

            <div [ngbTooltip]="'Galactic coordinates' | translate" class="galactic d-flex gap-2">
              <span [innerHTML]="mouseHoverGalacticRa"></span>
              <span [innerHTML]="mouseHoverGalacticDec"></span>
            </div>
          </div>

          <span>
            Powered by <a astrobinEventStopPropagation href="https://pixinsight.com/" target="_blank">PixInsight</a>
          </span>
        </div>

        <div [style.top.px]="mouseHoverY" class="x-ruler"></div>

        <div [style.left.px]="mouseHoverX" class="y-ruler"></div>
      </div>

      <button *ngIf="showNextButton" (click)="onArrowRight($event)" class="next-button">
        <fa-icon icon="chevron-right"></fa-icon>
      </button>

      <astrobin-image-viewer-revisions
        [activeLabel]="revisionLabel"
        [class.show]="showRevisions"
        [image]="image"
        (revisionSelected)="onRevisionSelected($event, true)"
      ></astrobin-image-viewer-revisions>

      <button *ngIf="image?.revisions?.length" (click)="showRevisions = !showRevisions" class="revisions-mobile-button">
        <fa-icon *ngIf="!showRevisions" icon="ellipsis"></fa-icon>
        <fa-icon *ngIf="showRevisions" icon="angle-down"></fa-icon>
      </button>
    </div>
  </div>
</ng-template>

<ng-template #descriptionTemplate let-currentUser="currentUser">
  <ng-container *ngIf="image?.descriptionBbcode || image.description">
    <div class="metadata-header">{{ "Description" | translate }}</div>

    <div *ngIf="translatedDescription" class="metadata-section flex-wrap">
      <div class="metadata-item description translated-content">
        <small class="text-muted fst-italic d-block mb-2">{{ "Translated" | translate }}</small>
        <div [innerHTML]="translatedDescription"></div>
      </div>
    </div>

    <div *ngIf="!translatedDescription && image?.descriptionBbcode" class="metadata-section flex-wrap">
      <div
        *ngIf="image.descriptionBbcode | BBCodeToHtml | async as html; else descriptionLoading"
        [innerHTML]="html | highlight: searchModel?.text?.value"
        (click)="onDescriptionClicked($event)"
        class="metadata-item description"
      ></div>
      <ng-template #descriptionLoading>
        <div class="metadata-item description">
          <small><fa-icon animation="spin" icon="spinner"></fa-icon> {{ "Loading content..." | translate }}</small>
        </div>
      </ng-template>
    </div>

    <div *ngIf="!translatedDescription && !image.descriptionBbcode && image?.description" class="metadata-section">
      <div [innerHTML]="image.description" class="metadata-item description"></div>
    </div>

    <button
      *ngIf="
        image &&
        image.detectedLanguage &&
        image.detectedLanguage !== translateService.currentLang &&
        (image.descriptionBbcode || image.description) &&
        !translatedDescription &&
        currentUser
      "
      (click)="onTranslateDescriptionClicked($event)"
      class="btn btn-link text-muted btn-no-block w-auto text-start ms-2 mb-5 btn-translate-description"
    >
      <fa-icon icon="language"></fa-icon>
      {{ "Translate" | translate }}

      <fa-icon *ngIf="translatingDescription" @fadeInOut class="ms-2" animation="spin" icon="circle-notch"></fa-icon>
    </button>

    <button
      *ngIf="translatedDescription"
      (click)="onSeeOriginalDescriptionClicked($event)"
      class="btn btn-link text-muted btn-no-block w-auto text-start ms-2 mb-5 btn-translate-description"
    >
      <fa-icon icon="language"></fa-icon>
      {{ "See original" | translate }}
    </button>
  </ng-container>
</ng-template>

<ng-template #moreFromThisUserTemplate>
  <div class="metadata-header mb-3">{{ "More from this user" | translate }}</div>
  <astrobin-image-search
    [loadMoreOnScroll]="false"
    [model]="{ userId: image.user, ordering: '-likes', pageSize: 25 }"
    [showMarketplaceItems]="false"
    [showRetailers]="false"
    [showStaticOverlay]="false"
    class="more-from-this-photographer mb-5"
  ></astrobin-image-search>
</ng-template>

<ng-template #similarToThisTemplate>
  <div class="metadata-header mb-3">
    <ng-container
      *ngIf="revision?.solution?.ra !== null && revision?.solution?.dec !== null; else relatedImagesLabelTemplate"
    >
      {{ "Images in the same area" | translate }}
    </ng-container>
    <ng-template #relatedImagesLabelTemplate>
      {{ "Related images" | translate }}
    </ng-template>
  </div>
  <astrobin-image-search
    [loadMoreOnScroll]="true"
    [model]="{ similarToImageId: this.image.hash || this.image.pk, ordering: '-likes', pageSize: 50 }"
    [showMarketplaceItems]="false"
    [showRetailers]="false"
    [showStaticOverlay]="false"
    class="similar-to-this"
  ></astrobin-image-search>
</ng-template>

<ng-template #upgradeToPlateSolveBannerMessageTemplate>
  <div class="flex-grow-1">
    <fa-icon class="me-2" icon="exclamation-triangle"></fa-icon>
    <span>{{ "Upgrade your account to enable plate-solving." | translate }}</span>
  </div>
  <a href="https://welcome.astrobin.com/pricing" rel="noopener" target="_blank">
    {{ "Learn more" | translate }}
  </a>
</ng-template>

<ng-template #dataAreaTemplate>
  <div #dataArea *ngIf="currentUserWrapper$ | async as currentUserWrapper" [class.d-none]="!adConfig" class="data-area">
    <astrobin-ad-manager
      #ad
      *ngIf="active && adConfig"
      [class.d-none]="!showAd"
      [configName]="adConfig"
      (adDisplayed)="adDisplayed = true"
    ></astrobin-ad-manager>

    <astrobin-image-viewer-wip-banner
      *ngIf="image && image.isWip && currentUserWrapper.user?.id === image.user"
      [image]="image"
      class="image-viewer-banner-component"
    ></astrobin-image-viewer-wip-banner>

    <astrobin-image-viewer-plate-solving-banner
      *ngIf="
        image &&
        showPlateSolvingBanner &&
        (currentUserWrapper.user?.id === image.user || currentUserWrapper.user?.isSuperUser)
      "
      [image]="image"
      [revisionLabel]="revisionLabel"
      (solutionChange)="onSolutionChange($event)"
      class="image-viewer-banner-component"
    ></astrobin-image-viewer-plate-solving-banner>

    <astrobin-image-viewer-custom-message-banner
      *ngIf="(showUpgradeToPlateSolveBanner$ | async) === true"
      [messageTemplate]="upgradeToPlateSolveBannerMessageTemplate"
      class="image-viewer-banner-component"
      alertClass="info"
    ></astrobin-image-viewer-custom-message-banner>

    <astrobin-image-viewer-title
      [image]="image"
      [revisionLabel]="revisionLabel"
      [searchModel]="searchModel"
    ></astrobin-image-viewer-title>

    <astrobin-image-viewer-floating-title #floatingTitle [image]="image"></astrobin-image-viewer-floating-title>

    <astrobin-image-viewer-photographers
      *ngIf="userContentType"
      [image]="image"
      [revision]="revision"
      [userContentType]="userContentType"
    ></astrobin-image-viewer-photographers>

    <div class="metadata-striped">
      <astrobin-image-viewer-groups-and-collections
        *ngIf="image?.partOfGroupSet?.length || image?.collections?.length"
        [image]="image"
      ></astrobin-image-viewer-groups-and-collections>

      <astrobin-image-viewer-data-source
        [image]="image"
        [searchModel]="searchModel"
      ></astrobin-image-viewer-data-source>

      <astrobin-image-viewer-astrometry
        *ngIf="revision?.solution?.ra !== null && revision?.solution?.dec !== null"
        [image]="image"
        [revisionLabel]="revisionLabel"
        [searchModel]="searchModel"
      ></astrobin-image-viewer-astrometry>
    </div>

    <astrobin-image-viewer-acquisition
      *ngIf="image?.deepSkyAcquisitions?.length || image?.solarSystemAcquisitions?.length"
      [image]="image"
      [searchModel]="searchModel"
    ></astrobin-image-viewer-acquisition>

    <astrobin-image-viewer-equipment
      *ngIf="image && imageService.hasEquipment(image)"
      [image]="image"
      [searchModel]="searchModel"
    ></astrobin-image-viewer-equipment>

    <astrobin-image-viewer-guiding-equipment
      *ngIf="image && imageService.hasGuidingEquipment(image)"
      [image]="image"
    ></astrobin-image-viewer-guiding-equipment>

    <astrobin-image-viewer-objects
      *ngIf="revision?.solution?.objectsInField || revision?.solution?.advancedAnnotations"
      [image]="image"
      [revisionLabel]="revisionLabel"
      [searchModel]="searchModel"
    ></astrobin-image-viewer-objects>

    <ng-container
      [ngTemplateOutlet]="descriptionTemplate"
      [ngTemplateOutletContext]="{
        currentUser: currentUserWrapper.user
      }"
    ></ng-container>

    <astrobin-image-viewer-revision-summary
      *ngIf="image?.revisions?.length > 0"
      [revision]="revision"
    ></astrobin-image-viewer-revision-summary>

    <ng-container [ngTemplateOutlet]="nestedCommentsTemplate"></ng-container>

    <ng-container [ngTemplateOutlet]="moreFromThisUserTemplate"></ng-container>

    <ng-container [ngTemplateOutlet]="similarToThisTemplate"></ng-container>
  </div>
  <!-- data-area -->
</ng-template>

<ng-template #nestedCommentsTemplate>
  <div class="image-viewer-comments-header metadata-header mb-3">{{ "Comments" | translate }}</div>

  <ng-container *ngIf="image && !image.allowComments">
    <p class="px-2">
      {{ "The photographer has not enabled comments for this image." | translate }}
    </p>
  </ng-container>

  <ng-container *ngIf="image?.allowComments">
    <ng-container *ngIf="currentUserWrapper$ | async as currentUserWrapper">
      <astrobin-nested-comments
        *ngIf="imageContentType; else loadingTemplate"
        [allowModeration]="currentUserWrapper.user?.id === image.user"
        [contentType]="imageContentType"
        [objectId]="image.pk"
        [showCloseButton]="false"
        class="d-block mb-5"
      ></astrobin-nested-comments>
    </ng-container>
  </ng-container>
</ng-template>
